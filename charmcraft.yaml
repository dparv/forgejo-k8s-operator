type: charm
name: forgejo-k8s
title: Forgejo K8s Operator
summary: Charmed Kubernetes operator for Forgejo.
description: |
  Deploy and configure the software forge, Forgejo.

base: ubuntu@22.04
platforms:
  amd64:
  arm64:

requires:
  database:
    interface: postgresql_client
    limit: 1
    optional: false
    description: |
      Integration to obtain an database backend for Foregjo.
  logging:
    interface: loki_push_api
    optional: true
    description: |
      Integration to push logs for loki typically through grafana-agent.
  ingress:
    # interface: ingress
    interface: traefik_route
    optional: true
    limit: 1
    description: |
      Integration to obtain an ingressed address to access Foregjo from outside the model.
      Note that you should use subdomain mode in traefik with a custom domain name.

provides:
  metrics-endpoint:
    interface: prometheus_scrape
    optional: true
  grafana-dashboard:
    interface: grafana_dashboard
    optional: true

charm-libs:
  - lib: data_platform_libs.data_interfaces
    version: "0"
  - lib: grafana_k8s.grafana_dashboard
    version: "0"
  - lib: loki_k8s.loki_push_api
    version: "1"
  - lib: observability_libs.juju_topology
    version: "0"
  - lib: prometheus_k8s.prometheus_scrape
    version: "0"
  - lib: traefik_k8s.traefik_route
    version: "0"


containers:
  forgejo:
    resource: forgejo-image
    mounts:
      - storage: data
        location: /data

storage:
  data:
    minimum-size: 10G
    type: filesystem

resources:
  forgejo-image:
    type: oci-image
    description: OCI image for the Forgejo container
    upstream-source: codeberg.org/forgejo/forgejo:11.0.3

parts:
  charm:
    plugin: charm
    source: .

config:
  options:
    log-level:
      description: |
        Configures the log level of Forgejo.

        Acceptable values are one of trace, debug, info, warn, error, or fatal.
      default: "info"
      type: string
    domain:
      description: |
        Domain name to use as root url for Forgejo.

        If not specified, the juju aplication name is used. Note that when related to an ingress app like traefik,
        the final url has both domains, like <forgejo-charm-config-domain>.<ingress-domain>
      default: "forgejo.internal"
      type: string

assumes:
  - juju >= 3.5
  - k8s-api

actions:
  generate-runner-secret:
    description: Generate a registration secret for a Forgejo Actions Runner.
    params:
      name:
        type: string
        description: Name of the runner (default is "runner")
      labels:
        type: string
        description: |
          comma separated list of labels supported by the runner
          (e.g. docker,ubuntu-latest,self-hosted) (default is "docker")
      scope:
        type: string
        description: owner/repo; leave empty for a global runner

  create-admin-user:
    description: Create an admin user in Forgejo with random password.
    params:
      username:
        type: string
        description: Username for the new admin user (default is "admin")
      email:
        type: string
        description: Email is requried
    required:
    - username
    - email

